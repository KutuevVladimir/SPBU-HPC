include BUILD.cfg

MPICC=mpiicc
MPILD=mpiicc
MPICFLAGS += -Wall -Wextra -pedantic -Ofast -xHost -ipo 
MPIDLFLAGS += -ipo
MPILIBS += -lm

CC=icc
LD=icc
CFLAGS += -Wall -Wextra -pedantic -Ofast -xHost -ipo 
LDFLAGS += -ipo 

MPI_PREFIX=MPI_
MPI_TARGET=$(BUILD_DIR)/$(MPI_REALIZATION)
MPI_SOURCES=$(wildcard $(SOURCE_DIR)/$(MPI_SOURCE_DIR)/*.c)
MPI_OBJECTS=$(patsubst $(SOURCE_DIR)/$(MPI_SOURCE_DIR)/%.c, $(BUILD_DIR)/$(MPI_PREFIX)%.o, $(MPI_SOURCES))

CONSISTENT_PREFIX=CONSISTENT_
CONSISTENT_TARGET=$(BUILD_DIR)/$(CONSISTENT_REALIZATION)
CONSISTENT_SOURCES=$(wildcard $(SOURCE_DIR)/$(CONSISTENT_SOURCE_DIR)/*.c)
CONSISTENT_OBJECTS=$(patsubst $(SOURCE_DIR)/$(CONSISTENT_SOURCE_DIR)/%.c, $(BUILD_DIR)/$(CONSISTENT_PREFIX)%.o, $(CONSISTENT_SOURCES))

.PHONY: all clean

all: $(MPI_TARGET) $(CONSISTENT_TARGET)

$(MPI_TARGET): $(MPI_OBJECTS)
	$(MPILD) $(MPILDFLAGS) $^ $(MPILIBS) -o $@

$(BUILD_DIR)/$(MPI_PREFIX)%.o: $(SOURCE_DIR)/$(MPI_SOURCE_DIR)/%.c | $(BUILD_DIR)
	$(MPICC) $(MPICFLAGS) -c $< -o $@

$(CONSISTENT_TARGET): $(CONSISTENT_OBJECTS)
	$(LD) $(LDFLAGS) $^ -o $@

$(BUILD_DIR)/$(CONSISTENT_PREFIX)%.o: $(SOURCE_DIR)/$(CONSISTENT_SOURCE_DIR)/%.c | $(BUILD_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

$(BUILD_DIR):
	mkdir -p $@

clean:
	$(RM) $(MPI_TARGET) $(MPI_OBJECTS) $(CONSISTENT_TARGET) $(CONSISTENT_OBJECTS)

